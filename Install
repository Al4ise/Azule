#!/bin/bash

cd $AZULE

case $(uname) in
    Darwin)
        if [[ "$(uname -m)" == arm64 || "$(uname -m)" == x86_64 ]]; then
            ar="ar"
            plutil="plutil"
    
            # CHECK IF XCODE CLI UTILS EXIST
            xcode-select -p 1>/dev/null
            if [ $? != 0 ]; then
                xcode-select --install
            fi
        else
            echo "You don't need to run this script on iOS"
            exit 1
        fi
    ;;
    
    Linux)
        ar="$AZULE/toolchain/usr/bin/ar"
        plutil="$AZULE/usr/bin/plutil"
        
        # GET TOOLCHAIN
        
        mkdir -p $AZULE/toolchain
        if [ ! "$(ls -A $AZULE/toolchain)" ]; then
            echo "Fetching toolchain..."
            curl -sSLO https://github.com/CRKatri/llvm-project/releases/download/swift-5.3.2-RELEASE/swift-5.3.2-RELEASE-ubuntu18.04.tar.zst
            TMP=$(mktemp -d)
            tar -I zstd -xf swift-5.3.2-RELEASE-ubuntu18.04.tar.zst -C $TMP
            rsync --remove-source-files -a $TMP/swift-5.3.2-RELEASE-ubuntu18.04/* $AZULE/toolchain
            rm -r swift-5.3.2-RELEASE-ubuntu18.04.tar.zst $TMP
        fi
    ;;
esac

while getopts ":fh" args; do
    case "$args" in
        f) git reset --hard HEAD >> /dev/null ;;
        
        h)
            echo "Usage: update-azule [options]"
            echo
            echo "Running the command without any arguments will update Azule normally. If"
            echo "you have made changes to any of Azule's files, the update will be cancelled."
            echo
            echo "Options:"
            echo "  -f     Forcefully update Azule, causing all local changes to be lost."
            echo "  -h     Print this help menu."
            exit 1
            ;;
            
        *)
        
            echo 'Invalid argument. Run "update-azule -h" to print the help menu.'
            exit 1
            ;;
    esac
done
git pull -q

if [ ! -d "$AZULE/CydiaSubstrate.framework" ]; then
    currentdir="$PWD"
    mkdir -p ar
    cd ar
    echo "Downloading CydiaSubstrate..."
    curl -sSLo substrate.deb "http://apt.saurik.com/debs/mobilesubstrate_0.9.6301_iphoneos-arm.deb"
    "$ar" -x "substrate.deb"
    tar --lzma --strip-components 3 -xf data.tar.lzma "./Library/Frameworks/CydiaSubstrate.framework"
    rm -rf substrate.deb data.tar.lzma CydiaSubstrate.framework/Libraries CydiaSubstrate.framework/Commands
    "$plutil" -convert binary1 "CydiaSubstrate.framework/Info.plist" || true
    mv CydiaSubstrate.framework "$AZULE/CydiaSubstrate.framework"
    cd "$currentdir"
    rm -rf ar
    echo "Downloaded CydiaSubstrate.framework"
fi

# UPDATE-AZULE GLOBAL COMMAND
if [ ! -f /usr/local/bin/update-azule ]; then
    sudo ln -s $AZULE/Install /usr/local/bin/update-azule
fi

# AZULE GLOBAL COMMAND
if [ ! -f /usr/local/bin/azule ]; then
    sudo ln -s $AZULE/azule /usr/local/bin/azule
fi

# CLEANUP
rm -rf $AZULE/.tmp
