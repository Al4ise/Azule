#!/bin/zsh

# DECLARE $TWEAKNAME
while
    printf 'Project Name: '
    read -r tweakname
    [ -z "$tweakname" ] && echo 'Nice try. Now name your project.'
do true; done

# MAKE .TMP
dir=$AZULE/Work
mkdir -p "$dir"/DEBS
mkdir -p "$dir"/"$tweakname"/Tweak/Resources
cd "$dir"/"$tweakname"

# GET IPA
while
    printf 'IPA Directory: '
    read ipadir
    [ -z "$ipadir" ] && echo 'I kind of need the IPA to make your app...'
do true; done

# EXTRACT IPA
eval "unzip -q "$ipadir" -d "$dir/$tweakname""

# SET OUTPUT DIRECTORY
while
    printf 'Output Directory: '
    read outdir
    [ -z "$outdir" ] && echo 'What am I supposed to do with your app then?'
do true; done

# GET FILES
while
    printf 'Files or Tweak IDs: '
    read twk
    [ -z "$twk" ] && echo 'You want me to not touch your app? Impossible.'
do true; done

eval "tweakids=( $(echo $twk | tr " " "\n") )"
for i in "${tweakids[@]}"; do
    if [[ -f "$i" || -d "$i" ]]; then
        case "$i" in
            *.deb)
                rsync -a "$i" "$dir"/DEBS
                dpkg -x "$dir"/DEBS/$(basename "$i") "$dir"/"$tweakname"/Tweak
                debs=1
                ;;

            *.dylib)
                rsync -a "$i" "$dir"/"$tweakname"/Tweak
                dylibnames+=( $(basename "$i") )
                ;;

            *.bundle|*.framework)
                rsync -a "$i" "$dir"/"$tweakname"/Tweak
                ;;
            
            *)
                rsync -a "$i" "$dir"/"$tweakname"/Tweak/Resources
                ;;
        esac
    else
        if [ "$(curl -s "https://api.parcility.co/db/package/$i" | jq -r '.status')" = "true" ]; then
            curl -s -Lo $dir/DEBS/$i.deb "$(curl -s "https://api.parcility.co/db/package/$i" | jq -r '.data.repo.url + .data.builds[-1].Filename')"
            dpkg -x "$dir"/DEBS/"$i".deb "$dir"/"$tweakname"/Tweak
        else
            echo ""$i" isn't available on Parcility. Try manually getting the files to inject."
        fi
    debs=1
    fi
    
done

# SPECIFY DYLIBS
if [ "$debs" = "1" ]; then
    dlb=( $(find -E "$dir"/"$tweakname"/Tweak -iname '*.dylib' -exec basename {} \;) "Done" )
    while
        echo 'Available Dylibs: '
        PS3="Choose Dylibs: "
            select i in "${dlb[@]}";
            do
                if [ "$i" = "Done" ]; then
                    break
                    else
                    dylibnames+=( "$i" )
                fi
            done
    [ -z "$dylibnames" ] && echo 'Did you just give me all of those files for nothing? Nope.'
    do true; done
fi

# MOVE BUNDLES
find -E "$dir"/"$tweakname"/Tweak -iname '*.bundle' ! -iregex '.*\.(bundle)/.+' -exec rsync -a --remove-source-files {} Payload/*.app \;

# MERGE RESOURCES
rsync -a --remove-source-files "$dir"/"$tweakname"/Tweak/Resources/ "$dir"/"$tweakname"/Payload/*.app/

# INJECT DYLIBS
executable=("$dir"/"$tweakname"/Payload/*.app/$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" Payload/*.app/Info.plist))

for i in "${dylibnames[@]}"; do
    find -E "$dir"/"$tweakname"/Tweak -iname "$i" ! -iregex '.*\.(app)/.+' -exec rsync -a --remove-source-files {} Payload/*.app/Frameworks \;
    $AZULE/insert_dylib --inplace --all-yes "@rpath/$i" "$executable"
done

# FIX LINKS
chain+=( $dylibnames )
frameworks=( $(find -E "$dir"/"$tweakname"/Tweak -iname '*.framework') $AZULE/CydiaSubstrate.framework )

for i in "${frameworks[@]}"; do
    rsync -a "$i" Payload/*.app/Frameworks
    chain+=( "$(basename "$i")/$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "$i"/Info.plist)" )
done

for i in "${chain[@]}" ;do
    codesign --remove-signature Payload/*.app/Frameworks/"$i"
    links=( $(otool -L Payload/*.app/Frameworks/"$i" | cut -d ' ' -f1) )
    for u in "${links[@]}"; do
        for x in "${chain[@]}"; do
            if [[ "$u" =~ "$x" ]]; then
                install_name_tool -change "$u" @rpath/"$x" Payload/*.app/Frameworks/"$i"
            fi
        done
    done
done

# WRAPPING UP
eval "zip -rqX "$outdir/$tweakname.ipa" Payload"
rm -rf "$dir"
